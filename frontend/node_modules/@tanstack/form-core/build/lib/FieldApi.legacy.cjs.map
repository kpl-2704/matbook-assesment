{"version":3,"file":"FieldApi.legacy.cjs","sources":["../../src/FieldApi.ts"],"sourcesContent":["import type { DeepKeys, DeepValue, Updater } from './utils'\nimport type { FormApi, ValidationError } from './FormApi'\nimport { Store } from '@tanstack/store'\n\nexport type ValidationCause = 'change' | 'blur' | 'submit'\n\ntype ValidateFn<TData, TFormData> = (\n  value: TData,\n  fieldApi: FieldApi<TData, TFormData>,\n) => ValidationError\n\ntype ValidateAsyncFn<TData, TFormData> = (\n  value: TData,\n  fieldApi: FieldApi<TData, TFormData>,\n) => ValidationError | Promise<ValidationError>\n\nexport interface FieldOptions<\n  _TData,\n  TFormData,\n  /**\n   * This allows us to restrict the name to only be a valid field name while\n   * also assigning it to a generic\n   */\n  TName = unknown extends TFormData ? string : DeepKeys<TFormData>,\n  /**\n   * If TData is unknown, we can use the TName generic to determine the type\n   */\n  TData = unknown extends _TData ? DeepValue<TFormData, TName> : _TData,\n> {\n  name: TName\n  index?: TData extends any[] ? number : never\n  defaultValue?: TData\n  asyncDebounceMs?: number\n  asyncAlways?: boolean\n  onMount?: (formApi: FieldApi<TData, TFormData>) => void\n  onChange?: ValidateFn<TData, TFormData>\n  onChangeAsync?: ValidateAsyncFn<TData, TFormData>\n  onChangeAsyncDebounceMs?: number\n  onBlur?: ValidateFn<TData, TFormData>\n  onBlurAsync?: ValidateAsyncFn<TData, TFormData>\n  onBlurAsyncDebounceMs?: number\n  onSubmitAsync?: ValidateAsyncFn<TData, TFormData>\n  defaultMeta?: Partial<FieldMeta>\n}\n\nexport type FieldApiOptions<TData, TFormData> = FieldOptions<\n  TData,\n  TFormData\n> & {\n  form: FormApi<TFormData>\n}\n\nexport type FieldMeta = {\n  isTouched: boolean\n  touchedError?: ValidationError\n  error?: ValidationError\n  isValidating: boolean\n}\n\nlet uid = 0\n\nexport type FieldState<TData> = {\n  value: TData\n  meta: FieldMeta\n}\n\n/**\n * TData may not be known at the time of FieldApi construction, so we need to\n * use a conditional type to determine if TData is known or not.\n *\n * If TData is not known, we use the TFormData type to determine the type of\n * the field value based on the field name.\n */\ntype GetTData<Name, TData, TFormData> = unknown extends TData\n  ? DeepValue<TFormData, Name>\n  : TData\n\nexport class FieldApi<TData, TFormData> {\n  uid: number\n  form: FormApi<TFormData>\n  name!: DeepKeys<TFormData>\n  /**\n   * This is a hack that allows us to use `GetTData` without calling it everywhere\n   *\n   * Unfortunately this hack appears to be needed alongside the `TName` hack\n   * further up in this file. This properly types all of the internal methods,\n   * while the `TName` hack types the options properly\n   */\n  _tdata!: GetTData<typeof this.name, TData, TFormData>\n  store!: Store<FieldState<typeof this._tdata>>\n  state!: FieldState<typeof this._tdata>\n  prevState!: FieldState<typeof this._tdata>\n  options: FieldOptions<typeof this._tdata, TFormData> = {} as any\n\n  constructor(opts: FieldApiOptions<TData, TFormData>) {\n    this.form = opts.form\n    this.uid = uid++\n    // Support field prefixing from FieldScope\n    // let fieldPrefix = ''\n    // if (this.form.fieldName) {\n    //   fieldPrefix = `${this.form.fieldName}.`\n    // }\n\n    this.name = opts.name as any\n\n    this.store = new Store<FieldState<typeof this._tdata>>(\n      {\n        value: this.getValue(),\n        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n        meta: this._getMeta() ?? {\n          isValidating: false,\n          isTouched: false,\n          ...opts.defaultMeta,\n        },\n      },\n      {\n        onUpdate: () => {\n          const state = this.store.state\n\n          state.meta.touchedError = state.meta.isTouched\n            ? state.meta.error\n            : undefined\n\n          this.prevState = state\n          this.state = state\n        },\n      },\n    )\n\n    this.state = this.store.state\n    this.prevState = this.state\n    this.options = opts as never\n  }\n\n  mount = () => {\n    const info = this.getInfo()\n    info.instances[this.uid] = this\n\n    const unsubscribe = this.form.store.subscribe(() => {\n      this.store.batch(() => {\n        const nextValue = this.getValue()\n        const nextMeta = this.getMeta()\n\n        if (nextValue !== this.state.value) {\n          this.store.setState((prev) => ({ ...prev, value: nextValue }))\n        }\n\n        if (nextMeta !== this.state.meta) {\n          this.store.setState((prev) => ({ ...prev, meta: nextMeta }))\n        }\n      })\n    })\n\n    this.update(this.options as never)\n    this.options.onMount?.(this as never)\n\n    return () => {\n      unsubscribe()\n      delete info.instances[this.uid]\n      if (!Object.keys(info.instances).length) {\n        delete this.form.fieldInfo[this.name]\n      }\n    }\n  }\n\n  update = (opts: FieldApiOptions<typeof this._tdata, TFormData>) => {\n    // Default Value\n    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n    if (this.state.value === undefined) {\n      const formDefault =\n        opts.form.options.defaultValues?.[opts.name as keyof TFormData]\n\n      if (opts.defaultValue !== undefined) {\n        this.setValue(opts.defaultValue as never)\n      } else if (formDefault !== undefined) {\n        this.setValue(formDefault as never)\n      }\n    }\n\n    // Default Meta\n    if (this._getMeta() === undefined) {\n      this.setMeta(this.state.meta)\n    }\n\n    this.options = opts as never\n  }\n\n  getValue = (): typeof this._tdata => {\n    return this.form.getFieldValue(this.name)\n  }\n\n  setValue = (\n    updater: Updater<typeof this._tdata>,\n    options?: { touch?: boolean; notify?: boolean },\n  ) => {\n    this.form.setFieldValue(this.name, updater as never, options)\n    this.validate('change', this.state.value)\n  }\n\n  _getMeta = () => this.form.getFieldMeta(this.name)\n  getMeta = () =>\n    this._getMeta() ??\n    ({\n      isValidating: false,\n      isTouched: false,\n      ...this.options.defaultMeta,\n    } as FieldMeta)\n\n  setMeta = (updater: Updater<FieldMeta>) =>\n    this.form.setFieldMeta(this.name, updater)\n\n  getInfo = () => this.form.getFieldInfo(this.name)\n\n  pushValue = (\n    value: typeof this._tdata extends any[]\n      ? (typeof this._tdata)[number]\n      : never,\n  ) => this.form.pushFieldValue(this.name, value as any)\n\n  insertValue = (\n    index: number,\n    value: typeof this._tdata extends any[]\n      ? (typeof this._tdata)[number]\n      : never,\n  ) => this.form.insertFieldValue(this.name, index, value as any)\n\n  removeValue = (index: number) => this.form.removeFieldValue(this.name, index)\n\n  swapValues = (aIndex: number, bIndex: number) =>\n    this.form.swapFieldValues(this.name, aIndex, bIndex)\n\n  getSubField = <TName extends DeepKeys<typeof this._tdata>>(name: TName) =>\n    new FieldApi<DeepValue<typeof this._tdata, TName>, TFormData>({\n      name: `${this.name}.${name}` as never,\n      form: this.form,\n    })\n\n  validateSync = (value = this.state.value, cause: ValidationCause) => {\n    const { onChange, onBlur } = this.options\n    const validate =\n      cause === 'submit' ? undefined : cause === 'change' ? onChange : onBlur\n\n    if (!validate) return\n\n    // Use the validationCount for all field instances to\n    // track freshness of the validation\n    const validationCount = (this.getInfo().validationCount || 0) + 1\n    this.getInfo().validationCount = validationCount\n    const error = normalizeError(validate(value as never, this as never))\n\n    if (this.state.meta.error !== error) {\n      this.setMeta((prev) => ({\n        ...prev,\n        error,\n      }))\n    }\n\n    // If a sync error is encountered, cancel any async validation\n    if (this.state.meta.error) {\n      this.cancelValidateAsync()\n    }\n  }\n\n  #leaseValidateAsync = () => {\n    const count = (this.getInfo().validationAsyncCount || 0) + 1\n    this.getInfo().validationAsyncCount = count\n    return count\n  }\n\n  cancelValidateAsync = () => {\n    // Lease a new validation count to ignore any pending validations\n    this.#leaseValidateAsync()\n    // Cancel any pending validation state\n    this.setMeta((prev) => ({\n      ...prev,\n      isValidating: false,\n    }))\n  }\n\n  validateAsync = async (value = this.state.value, cause: ValidationCause) => {\n    const {\n      onChangeAsync,\n      onBlurAsync,\n      onSubmitAsync,\n      asyncDebounceMs,\n      onBlurAsyncDebounceMs,\n      onChangeAsyncDebounceMs,\n    } = this.options\n\n    const validate =\n      cause === 'change'\n        ? onChangeAsync\n        : cause === 'submit'\n        ? onSubmitAsync\n        : onBlurAsync\n\n    if (!validate) return\n\n    const debounceMs =\n      cause === 'submit'\n        ? 0\n        : (cause === 'change'\n            ? onChangeAsyncDebounceMs\n            : onBlurAsyncDebounceMs) ??\n          asyncDebounceMs ??\n          0\n\n    if (this.state.meta.isValidating !== true)\n      this.setMeta((prev) => ({ ...prev, isValidating: true }))\n\n    // Use the validationCount for all field instances to\n    // track freshness of the validation\n    const validationAsyncCount = this.#leaseValidateAsync()\n\n    const checkLatest = () =>\n      validationAsyncCount === this.getInfo().validationAsyncCount\n\n    if (!this.getInfo().validationPromise) {\n      this.getInfo().validationPromise = new Promise((resolve, reject) => {\n        this.getInfo().validationResolve = resolve\n        this.getInfo().validationReject = reject\n      })\n    }\n\n    if (debounceMs > 0) {\n      await new Promise((r) => setTimeout(r, debounceMs))\n    }\n\n    // Only kick off validation if this validation is the latest attempt\n    if (checkLatest()) {\n      try {\n        const rawError = await validate(value as never, this as never)\n\n        if (checkLatest()) {\n          const error = normalizeError(rawError)\n          this.setMeta((prev) => ({\n            ...prev,\n            isValidating: false,\n            error,\n          }))\n          this.getInfo().validationResolve?.(error)\n        }\n      } catch (error) {\n        if (checkLatest()) {\n          this.getInfo().validationReject?.(error)\n          throw error\n        }\n      } finally {\n        if (checkLatest()) {\n          this.setMeta((prev) => ({ ...prev, isValidating: false }))\n          delete this.getInfo().validationPromise\n        }\n      }\n    }\n\n    // Always return the latest validation promise to the caller\n    return this.getInfo().validationPromise\n  }\n\n  validate = (\n    cause: ValidationCause,\n    value?: typeof this._tdata,\n  ): ValidationError | Promise<ValidationError> => {\n    // If the field is pristine and validatePristine is false, do not validate\n    if (!this.state.meta.isTouched) return\n\n    // Attempt to sync validate first\n    this.validateSync(value, cause)\n\n    // If there is an error, return it, do not attempt async validation\n    if (this.state.meta.error) {\n      if (!this.options.asyncAlways) {\n        return this.state.meta.error\n      }\n    }\n\n    // No error? Attempt async validation\n    return this.validateAsync(value, cause)\n  }\n\n  handleChange = (updater: Updater<typeof this._tdata>) => {\n    this.setValue(updater, { touch: true })\n  }\n\n  handleBlur = () => {\n    const prevTouched = this.state.meta.isTouched\n    if (!prevTouched) {\n      this.setMeta((prev) => ({ ...prev, isTouched: true }))\n      this.validate('change')\n    }\n    this.validate('blur')\n  }\n}\n\nfunction normalizeError(rawError?: ValidationError) {\n  if (rawError) {\n    if (typeof rawError !== 'string') {\n      return 'Invalid Form Values'\n    }\n\n    return rawError\n  }\n\n  return undefined\n}\n"],"names":["uid","_leaseValidateAsync","WeakMap","FieldApi","constructor","opts","_this$_getMeta2","_defineProperty","_this$options$onMount","_this$options","info","getInfo","instances","unsubscribe","form","store","subscribe","batch","nextValue","getValue","nextMeta","getMeta","state","value","setState","prev","meta","update","options","onMount","call","Object","keys","length","fieldInfo","name","undefined","_opts$form$options$de","formDefault","defaultValues","defaultValue","setValue","_getMeta","setMeta","getFieldValue","updater","setFieldValue","validate","getFieldMeta","_this$_getMeta","isValidating","isTouched","defaultMeta","setFieldMeta","getFieldInfo","pushFieldValue","index","insertFieldValue","removeFieldValue","aIndex","bIndex","swapFieldValues","cause","onChange","onBlur","validationCount","error","normalizeError","cancelValidateAsync","_classPrivateFieldInitSpec","writable","count","validationAsyncCount","_classPrivateFieldGet","_ref","_ref2","onChangeAsync","onBlurAsync","onSubmitAsync","asyncDebounceMs","onBlurAsyncDebounceMs","onChangeAsyncDebounceMs","debounceMs","checkLatest","validationPromise","Promise","resolve","reject","validationResolve","validationReject","r","setTimeout","rawError","_this$getInfo$validat","_this$getInfo","_this$getInfo$validat2","_this$getInfo2","validateSync","asyncAlways","validateAsync","touch","prevTouched","Store","onUpdate","touchedError","prevState"],"mappings":"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"}